<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transwulator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
</head>
<body>

    <main>
        <div id="start-screen" class="screen active" onclick="showScreen('input-screen')">
            <img src="swu.jpg" alt="서울여자대학교 로고">
            <h1>Transwulator</h1>
            <p class="blinking-text">-아무 곳이나 클릭하여 시작-</p>
        </div>

        <div id="input-screen" class="screen">
            <p>번역하고 싶은 유튜브 url을 입력하세요.</p>
            <div id="url-input-container">
                <input type="text" id="url-input" placeholder="url 입력">
                <button class="btn-load" onclick="handleUrlInput()">불러오기</button>
            </div>
        </div>

        <div id="alert-message" class="alert-message">
            유효한 유튜브 링크가 아닙니다.
        </div>
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p>번역 중...</p>
        </div>


        <div id="result-screen" class="screen">
            <div id="result-content">
                <div class="video-area">
                    <div id="player"></div> </div>
                <div class="avatar-area">
                    <div id="viewer"></div> </div>
            </div>
        </div>

    </main>

    <footer>
        <p>© 2025 <span>Seoul Women’s University</span></p>
        <p>Data Science Capstone Design II · <strong>Team Transwulator</strong></p>
        <p>Members: Hyun-A Kang · Kyu-Eui Kim · Na-Yeon Kim</p>
    </footer>

    <script>
        const screens = document.querySelectorAll('.screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        const urlInput = document.getElementById('url-input');
        const alertMessage = document.getElementById('alert-message');
        const playerDiv = document.getElementById('player'); // player 요소 추가

        // 화면 전환 함수
        function showScreen(id) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        // 유튜브 URL 유효성 검사 함수 (간단화)
        function isValidYoutubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.|m\.)?(youtube\.com|youtu\.be)\/.+$/;
            return youtubeRegex.test(url);
        }

        // 알람 메시지 표시/숨김 함수
        function showAlert(message) {
            alertMessage.textContent = message;
            alertMessage.classList.add('show');
            setTimeout(() => {
                alertMessage.classList.remove('show');
            }, 2000); // 2초 후 사라짐
        }

        // URL 입력 및 불러오기 버튼 핸들러 (수정됨)
        function handleUrlInput() {
            const url = urlInput.value.trim();

            if (!isValidYoutubeUrl(url)) {
                showAlert('유효한 유튜브 링크가 아닙니다.');
                return;
            }
            
            // YouTube ID 추출 로직 추가
            const videoIdMatch = url.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]{11})/);
            if (!videoIdMatch) {
                 showAlert('유효한 유튜브 링크가 아닙니다.');
                 return;
            }
            const videoId = videoIdMatch[1];

            // 로딩 화면 표시
            loadingOverlay.style.display = 'flex';
            
            // 5초 뒤 결과 화면으로 이동
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                showScreen('result-screen');

                // 1. YouTube 영상 삽입 (iframe)
                playerDiv.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
                
                // 2. VRM 렌더링 시작
                if (window.initVrmScene) {
                     window.initVrmScene();
                }

            }, 5000); 
        }

    </script>
    
    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/@pixiv/three-vrm@1.0.12/lib/three-vrm.js"></script>
    
    <script>
        // 라이브러리가 로드되었는지 확인하는 대기 함수 (CDN 로드를 위해)
        function waitForLibs(callback) {
            if (typeof THREE !== 'undefined' && typeof THREE.GLTFLoader !== 'undefined' && typeof THREE_VRM !== 'undefined') {
                callback();
            } else {
                setTimeout(() => waitForLibs(callback), 100);
            }
        }

        window.initVrmScene = () => {
            waitForLibs(() => {
                // 전역 객체에서 필요한 클래스 및 모듈 가져오기
                const { Scene, WebGLRenderer, PerspectiveCamera, DirectionalLight, AmbientLight, Box3, Vector3 } = THREE;
                const { GLTFLoader } = THREE;
                const { VRMLoaderPlugin } = THREE_VRM;
                
                // ==========================
                // === VRM 수어 아바타 ===
                // ==========================
                const viewer = document.getElementById('viewer');
                
                // 씬 및 렌더러 초기화
                const scene = new Scene();
                const renderer = new WebGLRenderer({ antialias: true, alpha: true });
                
                // 렌더러 크기 설정: viewer 컨테이너 크기에 맞춰야 함
                const width = viewer.clientWidth;
                const height = viewer.clientHeight;

                renderer.setSize(width, height);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                viewer.appendChild(renderer.domElement);

                // 카메라 설정
                const camera = new PerspectiveCamera(30, width / height, 0.1, 100);
                camera.position.set(0, 1.4, 2.5);

                // 조명 설정
                const light = new DirectionalLight(0xffffff, 1);
                light.position.set(1, 1, 2);
                scene.add(light);
                scene.add(new AmbientLight(0xffffff, 0.4));

                let vrm;
                const loader = new GLTFLoader();
                loader.register(parser => new VRMLoaderPlugin(parser));

                loader.load(
                    'transwulator.vrm', // VRM 모델 파일 경로
                    gltf => {
                        vrm = gltf.userData.vrm;
                        scene.add(vrm.scene);
                        vrm.scene.position.y = 0.4;

                        // 카메라 위치 조정 로직
                        const bbox = new Box3().setFromObject(vrm.scene);
                        const size = bbox.getSize(new Vector3()).length();
                        const center = bbox.getCenter(new Vector3());
                        camera.position.set(center.x, center.y + size * 0.1, center.z + size * 1.2);
                        camera.lookAt(center);
                    },
                    xhr => console.log(`${(xhr.loaded / xhr.total * 100).toFixed(1)}% loaded`),
                    err => console.error('VRM 로드 오류:', err)
                );

                // === 렌더링 루프 ===
                function animate() {
                    requestAnimationFrame(animate);
                    // vrm.update(delta) 같은 애니메이션 업데이트 로직은 필요에 따라 추가
                    if (vrm) vrm.update(0.016); // 간단한 VRM 업데이트 추가 (프레임 시간 가정)
                    renderer.render(scene, camera);
                }
                animate();

                // === 리사이즈 대응 ===
                window.addEventListener('resize', () => {
                    const resizeWidth = viewer.clientWidth;
                    const resizeHeight = viewer.clientHeight;
                    camera.aspect = resizeWidth / resizeHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(resizeWidth, resizeHeight);
                });
            }); 
        };
    </script>
</body>
</html>